<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>change Feign And Loadbalancer Retry | _JJ@Developer</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="change Feign And Loadbalancer Retry" /><meta property="og:locale" content="en_US" /><meta name="description" content="This blog for software developing documentation." /><meta property="og:description" content="This blog for software developing documentation." /><link rel="canonical" href="http://localhost:4000/docs/msa/spring-cloud/spring_upgrade_retry/" /><meta property="og:url" content="http://localhost:4000/docs/msa/spring-cloud/spring_upgrade_retry/" /><meta property="og:site_name" content="_JJ@Developer" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-01T18:48:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="change Feign And Loadbalancer Retry" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-01T18:48:00+09:00","datePublished":"2022-10-01T18:48:00+09:00","description":"This blog for software developing documentation.","headline":"change Feign And Loadbalancer Retry","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/docs/msa/spring-cloud/spring_upgrade_retry/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/one_.png"}},"url":"http://localhost:4000/docs/msa/spring-cloud/spring_upgrade_retry/"}</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1261619070611227" crossorigin="anonymous"></script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"><div class="site-logo"></div></a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">Home</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/msa" class="nav-list-link">Msa</a><ul class="nav-list "><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/msa/spring-cloud/springcloud/" class="nav-list-link">SpringCloud</a><ul class="nav-list"></ul><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/msa/feign/feign/" class="nav-list-link">Feign</a><ul class="nav-list"></ul><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/msa/elastic-search/elasticsearch/" class="nav-list-link">Elastic Search</a><ul class="nav-list"></ul><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/msa/kafka/kafka/" class="nav-list-link">Kafka</a><ul class="nav-list"></ul><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/msa/nginx/nginx/" class="nav-list-link">Nginx</a><ul class="nav-list"></ul><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/msa/jpa/jpa/" class="nav-list-link">Jpa</a><ul class="nav-list"></ul><li class="nav-list-item "><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/msa/api/api/" class="nav-list-link">Api</a><ul class="nav-list"></ul></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/patterns" class="nav-list-link">Patterns</a><ul class="nav-list "></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/errors" class="nav-list-link">Errors</a><ul class="nav-list "></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/clipping" class="nav-list-link">Clipping</a><ul class="nav-list "></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/mooc" class="nav-list-link">Mooc</a><ul class="nav-list "></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/sub-projects" class="nav-list-link">Sub Projects</a><ul class="nav-list "></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/quality" class="nav-list-link">Quality Practice</a><ul class="nav-list "></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/etc" class="nav-list-link">Etc</a><ul class="nav-list "></ul><li class="nav-list-item"><a href="http://localhost:4000/docs/bookmark/" class="nav-list-link">★bookmark</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search _JJ@Developer" aria-label="Search _JJ@Developer" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/docs/msa">Msa</a><li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/docs/msa/spring-cloud/springcloud/">SpringCloud</a><li class="breadcrumb-nav-list-item"><span>change Feign And Loadbalancer Retry</span></ol></nav><div id="main-content" class="main-content" role="main"><header class="header-page"><h1 class="page-title"> change Feign And Loadbalancer Retry</h1><div class="page-date"><span>2022, Oct 01&nbsp;&nbsp;&nbsp;&nbsp;</span></div></header><div class="col-lg-8 col-md-10 mx-auto"> <span class="tag">spring cloud</span> <span class="tag">spring boot</span></div><h1 id="change-note"> <a href="#change-note" class="anchor-heading" aria-labelledby="change-note"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> change note</h1><ul><li>retry에 대한 처리<ul><li>resilience4j가 제공하는 functional 모델 중 retry에 대해서만 처리할 계획입니다<li>circuit breaker의 경우는 core application쪽에서 일임하고 있기 때문에 거기에 종속되어 동작하고 있어서, 비지니스 모델 중 일부 케이스만 retry를 커스텀할 수 있게 작업합니다.</ul><li>hystrix와 resilience4j 차이<ul><li>hystrix는 자바6 기반, resilience4j는 자바8기반<li>자바8기반이기 때문에 함수형으로 작성되었다는 것</ul><li>spring-retry, resilience4j의 retry, loadbalancer의 retry 차이<ul><li><a href="https://velog.io/@garden6/API-재시도를-처리할수-있는-여러가지-방안들">https://velog.io/@garden6/API-재시도를-처리할수-있는-여러가지-방안들</a> —&gt; 여기에 너무나도 잘 정리되어있다.<li>spring-retry<ul><li>annotation을 통해서 spring aop를 호출할 수 있다.<li>@EnableRetry, @Retryable을 통해 특정 exception일때 제어가 가능하며, method단위로도 설정이 가능하다<li>기본 구현 코드 : <a href="https://www.baeldung.com/spring-retry">https://www.baeldung.com/spring-retry</a></ul><li>resilience4j<ul><li>@Retry을 사용하며, 인스턴스 기반으로 Retry</ul></ul></ul><h2 id="1-change-dependency"> <a href="#1-change-dependency" class="anchor-heading" aria-labelledby="1-change-dependency"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. change dependency</h2><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-circuitbreaker-resilience4j<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><h2 id="2-problem"> <a href="#2-problem" class="anchor-heading" aria-labelledby="2-problem"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. problem</h2><ul><li>기존에는 Feign의 Retryer를 Bean으로 등록해두고 커스텀한 주기로 사용할 수 있게 FeignClient인터페이스에 configuration으로 등록해서 사용했었는데요.<li>이 기능이 스프링 버전업을 하게 되면서, loadbalancer에 등록한 instance들을 FeignClient로 호출할 때는 retry가 되고 있지 않은 문제가 발생했습니다.<li>spring-cloud-loadbalancer에 등록한 instance들을 통신할 때, 실패시 retry이 되도록 설정하면서 정리한 내용입니다.</ul><h3 id="try1"> <a href="#try1" class="anchor-heading" aria-labelledby="try1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> try1.</h3><ul><li>설정정보입니다. instance는 총 3대이고, 각각 2번씩 retry해야하는 설정입니다.</ul><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">cloud</span><span class="pi">:</span>
    <span class="na">loadbalancer</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">retry</span><span class="pi">:</span>
<span class="err">	</span>      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
<span class="err">	</span>      <span class="na">maxRetriesOnSameServiceInstance</span><span class="pi">:</span> <span class="m">2</span>
<span class="err">	</span>      <span class="na">maxRetriesOnNextServiceInstance</span><span class="pi">:</span> <span class="m">2</span>
<span class="err">	</span>      <span class="na">retryableStatusCodes</span><span class="pi">:</span> <span class="s">502, </span><span class="m">503</span>
</code></pre></div></div><ul><li>loadbalancer에 등록한 인스턴스 내부에서의 retry는 동작하고 있는데, <code class="language-plaintext highlighter-rouge">maxRetriesOnSameServiceInstance</code>에 대한 동작이 안되고 있음<li><code class="language-plaintext highlighter-rouge">RetryableFeignBlockingLoadBalancerClient</code>디버깅하면 아래처럼 <code class="language-plaintext highlighter-rouge">maxRetriesOnSameServiceInstance</code>이 0으로 나오고 있습니다.</ul><p><img src="../img/spring_upgrade_retry_1.png" alt="spring_upgrade_retry_1" /></p><h3 id="try2"> <a href="#try2" class="anchor-heading" aria-labelledby="try2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> try2.</h3><ul><li><p>좀더 상세 로그를 보기 위해 레벨을 trace로 변경했습니다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">logging</span><span class="pi">:</span>
    <span class="na">level</span><span class="pi">:</span>
<span class="err">  		</span><span class="s">org.springframework.cloud.openfeign.loadbalancer</span><span class="pi">:</span> <span class="s">trace</span>
</code></pre></div></div><li>디버깅하면 yml에 설정된 값으로 실행되지 않고 0으로 읽어가고 있습니다. 그래서 코드를 보니 loadbalanceProperties를 serviceId 하위로 찾고 있다는 것을 발견했습니다.<ul><li>yml을 아래처럼 instance의 serviceId 하위로 retry 설정을 추가하고 다시 테스트했습니다.<li>spring.cloud.loadbalancer.clients.[SERVICE-ID].retry</ul><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">spring</span><span class="pi">:</span>
    <span class="na">cloud</span><span class="pi">:</span>
      <span class="na">loadbalancer</span><span class="pi">:</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">clients</span><span class="pi">:</span>
          <span class="na">crema-gateway</span><span class="pi">:</span>
<span class="err">  	</span>        <span class="na">retry</span><span class="pi">:</span>
<span class="err">  		</span>        <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="err">		</span>        <span class="na">maxRetriesOnSameServiceInstance</span><span class="pi">:</span> <span class="m">2</span>
<span class="err">  		</span>        <span class="na">maxRetriesOnNextServiceInstance</span><span class="pi">:</span> <span class="m">2</span>
<span class="err">  		</span>        <span class="na">retryableStatusCodes</span><span class="pi">:</span> <span class="s">502, </span><span class="m">503</span>
</code></pre></div></div><li><p>설정한 값으로 잘 읽어오고 있습니다.</p><p><img src="../img/spring_upgrade_retry_2.png" alt="spring_upgrade_retry_2" /></p></ul><h3 id="try3"> <a href="#try3" class="anchor-heading" aria-labelledby="try3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> try3.</h3><ul><li><p>하지만 설정대로 retry하지 않아서, 상세로깅을 보기위해 retry의 로깅을 설정했습니다.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">logging</span><span class="pi">:</span>
    <span class="na">level</span><span class="pi">:</span>
      <span class="s">org.springframework.retry</span><span class="pi">:</span> <span class="s">trace</span>
</code></pre></div></div><li><p>로그를 보고자 하는 부분은 RetryTemplate.java의 doExecute 메서드 부분입니다.</p><p><img src="../img/spring_upgrade_retry_3.png" alt="spring_upgrade_retry_3" /></p><li><p>로깅을 추가한 후 로그입니다.</p><ul><li>serviceId를 crema-gateway로 선언한 후, nginx서비스를 내리고 호출해 본 것인데요.</ul><div class="language-prolog highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.481</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">f</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">Slf4jLogger</span>         <span class="o">:</span> <span class="m">72</span> <span class="ss">log</span>             <span class="p">[</span><span class="nv">KakaoWriteClient</span><span class="o">#</span><span class="ss">write</span><span class="p">]</span> <span class="o">---&gt;</span> <span class="nv">POST</span> <span class="ss">http</span><span class="o">://</span><span class="ss">crema</span><span class="o">-</span><span class="ss">gateway</span><span class="o">/</span><span class="ss">chat</span><span class="o">/</span><span class="ss">write</span> <span class="nv">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.481</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">f</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">Slf4jLogger</span>         <span class="o">:</span> <span class="m">72</span> <span class="ss">log</span>             <span class="p">[</span><span class="nv">KakaoWriteClient</span><span class="o">#</span><span class="ss">write</span><span class="p">]</span> <span class="nv">Accept</span><span class="o">:</span> <span class="ss">application</span><span class="o">/</span><span class="ss">json</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.482</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">f</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">Slf4jLogger</span>         <span class="o">:</span> <span class="m">72</span> <span class="ss">log</span>             <span class="p">[</span><span class="nv">KakaoWriteClient</span><span class="o">#</span><span class="ss">write</span><span class="p">]</span> <span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span><span class="o">:</span> <span class="m">168</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.482</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">f</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">Slf4jLogger</span>         <span class="o">:</span> <span class="m">72</span> <span class="ss">log</span>             <span class="p">[</span><span class="nv">KakaoWriteClient</span><span class="o">#</span><span class="ss">write</span><span class="p">]</span> <span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span><span class="o">:</span> <span class="ss">applicati</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.483</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">f</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">Slf4jLogger</span>         <span class="o">:</span> <span class="m">72</span> <span class="ss">log</span>             <span class="p">[</span><span class="nv">KakaoWriteClient</span><span class="o">#</span><span class="ss">write</span><span class="p">]</span> 
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.483</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">f</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">Slf4jLogger</span>         <span class="o">:</span> <span class="m">72</span> <span class="ss">log</span>             <span class="p">[</span><span class="nv">KakaoWriteClient</span><span class="o">#</span><span class="ss">write</span><span class="p">]</span> <span class="o">---&gt;</span> <span class="nv">END</span> <span class="nv">HTTP</span> <span class="p">(</span><span class="m">168</span><span class="o">-</span><span class="ss">byte</span> <span class="ss">body</span><span class="p">)</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.484</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">TRACE</span> <span class="ss">o</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="ss">r</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">RetryTemplate</span>   <span class="o">:</span><span class="m">280</span> <span class="ss">doExecute</span>       <span class="nv">RetryContext</span> <span class="ss">retrieved</span><span class="o">:</span> <span class="p">[</span><span class="nv">RetryContext</span><span class="o">:</span> <span class="ss">count</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="ss">lastException</span><span class="o">=</span><span class="ss">null</span><span class="p">,</span> <span class="ss">exhausted</span><span class="o">=</span><span class="ss">false</span><span class="p">]</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.484</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">o</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="ss">r</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">RetryTemplate</span>   <span class="o">:</span><span class="m">324</span> <span class="ss">doExecute</span>       <span class="nv">Retry</span><span class="o">:</span> <span class="ss">count</span><span class="o">=</span><span class="m">0</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.484</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">ockingLoadBalancerClient</span><span class="o">:</span><span class="m">130</span> <span class="ss">ambda</span><span class="err">$</span><span class="ss">execute</span><span class="err">$</span><span class="m">2</span> <span class="nv">Service</span> <span class="ss">instance</span> <span class="ss">retrieved</span> <span class="ss">from</span> <span class="nv">LoadBalancedRetryContext</span><span class="o">:</span> <span class="ss">was</span> <span class="ss">null</span><span class="p">.</span> <span class="nv">Reattempting</span> <span class="ss">service</span> <span class="ss">instance</span> <span class="ss">selection</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.485</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">WARN</span>  <span class="ss">c</span><span class="p">.</span><span class="nv">RoundRobinLoadBalancer</span><span class="o">:</span> <span class="m">98</span> <span class="ss">nstanceResponse</span> <span class="nv">No</span> <span class="ss">servers</span> <span class="ss">available</span> <span class="ss">for</span> <span class="ss">service</span><span class="o">:</span> <span class="ss">crema</span><span class="o">-</span><span class="ss">gateway</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.485</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">ockingLoadBalancerClient</span><span class="o">:</span><span class="m">138</span> <span class="ss">ambda</span><span class="err">$</span><span class="ss">execute</span><span class="err">$</span><span class="m">2</span> <span class="nv">Selected</span> <span class="ss">service</span> <span class="ss">instance</span><span class="o">:</span> <span class="ss">null</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">42.485</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">WARN</span>  <span class="ss">ockingLoadBalancerClient</span><span class="o">:</span><span class="m">145</span> <span class="ss">ambda</span><span class="err">$</span><span class="ss">execute</span><span class="err">$</span><span class="m">2</span> <span class="nv">Service</span> <span class="ss">instance</span> <span class="ss">was</span> <span class="ss">not</span> <span class="ss">resolved</span><span class="p">,</span> <span class="ss">executing</span> <span class="ss">the</span> <span class="ss">original</span> <span class="ss">request</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">44.783</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">o</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="ss">r</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">RetryTemplate</span>   <span class="o">:</span><span class="m">360</span> <span class="ss">doExecute</span>       <span class="nv">Checking</span> <span class="ss">for</span> <span class="ss">rethrow</span><span class="o">:</span> <span class="ss">count</span><span class="o">=</span><span class="m">1</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">44.783</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">o</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="ss">r</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">RetryTemplate</span>   <span class="o">:</span><span class="m">383</span> <span class="ss">doExecute</span>       <span class="nv">Retry</span> <span class="ss">failed</span> <span class="ss">last</span> <span class="ss">attempt</span><span class="o">:</span> <span class="ss">count</span><span class="o">=</span><span class="m">1</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">44.783</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">f</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">Slf4jLogger</span>         <span class="o">:</span> <span class="m">72</span> <span class="ss">log</span>             <span class="p">[</span><span class="nv">KakaoWriteClient</span><span class="o">#</span><span class="ss">write</span><span class="p">]</span> <span class="o">&lt;---</span> <span class="nv">ERROR</span> <span class="nv">UnknownHostException</span><span class="o">:</span> <span class="ss">crema</span><span class="o">-</span><span class="ss">gateway</span> <span class="p">(</span><span class="m">2299</span><span class="ss">ms</span><span class="p">)</span>
  <span class="m">13</span><span class="o">:</span><span class="m">49</span><span class="o">:</span><span class="mf">44.784</span> <span class="m">7</span><span class="o">-</span><span class="ss">thread</span><span class="o">-</span><span class="m">5</span> <span class="nv">DEBUG</span> <span class="ss">f</span><span class="p">.</span><span class="ss">s</span><span class="p">.</span><span class="nv">Slf4jLogger</span>         <span class="o">:</span> <span class="m">72</span> <span class="ss">log</span>             <span class="p">[</span><span class="nv">KakaoWriteClient</span><span class="o">#</span><span class="ss">write</span><span class="p">]</span> <span class="ss">java</span><span class="p">.</span><span class="ss">net</span><span class="p">.</span><span class="nv">UnknownHostException</span><span class="o">:</span> <span class="ss">crema</span><span class="o">-</span><span class="ss">gateway</span>
  	<span class="ss">at</span> <span class="ss">java</span><span class="p">.</span><span class="ss">net</span><span class="p">.</span><span class="nv">Inet6AddressImpl</span><span class="p">.</span><span class="ss">lookupAllHostAddr</span><span class="p">(</span><span class="nv">Native</span> <span class="nv">Method</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">java</span><span class="p">.</span><span class="ss">net</span><span class="p">.</span><span class="nv">InetAddress</span><span class="err">$</span><span class="m">2</span><span class="p">.</span><span class="ss">lookupAllHostAddr</span><span class="p">(</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">929</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">java</span><span class="p">.</span><span class="ss">net</span><span class="p">.</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">getAddressesFromNameService</span><span class="p">(</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">1324</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">java</span><span class="p">.</span><span class="ss">net</span><span class="p">.</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">getAllByName0</span><span class="p">(</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">1277</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">java</span><span class="p">.</span><span class="ss">net</span><span class="p">.</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">getAllByName</span><span class="p">(</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">1193</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">java</span><span class="p">.</span><span class="ss">net</span><span class="p">.</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">getAllByName</span><span class="p">(</span><span class="nv">InetAddress</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">1127</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">org</span><span class="p">.</span><span class="ss">apache</span><span class="p">.</span><span class="ss">http</span><span class="p">.</span><span class="ss">impl</span><span class="p">.</span><span class="ss">conn</span><span class="p">.</span><span class="nv">SystemDefaultDnsResolver</span><span class="p">.</span><span class="ss">resolve</span><span class="p">(</span><span class="nv">SystemDefaultDnsResolver</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">45</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">org</span><span class="p">.</span><span class="ss">apache</span><span class="p">.</span><span class="ss">http</span><span class="p">.</span><span class="ss">impl</span><span class="p">.</span><span class="ss">conn</span><span class="p">.</span><span class="nv">DefaultHttpClientConnectionOperator</span><span class="p">.</span><span class="ss">connect</span><span class="p">(</span><span class="nv">DefaultHttpClientConnectionOperator</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">112</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">org</span><span class="p">.</span><span class="ss">apache</span><span class="p">.</span><span class="ss">http</span><span class="p">.</span><span class="ss">impl</span><span class="p">.</span><span class="ss">conn</span><span class="p">.</span><span class="nv">PoolingHttpClientConnectionManager</span><span class="p">.</span><span class="ss">connect</span><span class="p">(</span><span class="nv">PoolingHttpClientConnectionManager</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">376</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">org</span><span class="p">.</span><span class="ss">apache</span><span class="p">.</span><span class="ss">http</span><span class="p">.</span><span class="ss">impl</span><span class="p">.</span><span class="ss">execchain</span><span class="p">.</span><span class="nv">MainClientExec</span><span class="p">.</span><span class="ss">establishRoute</span><span class="p">(</span><span class="nv">MainClientExec</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">393</span><span class="p">)</span>
  	<span class="ss">at</span> <span class="ss">org</span><span class="p">.</span><span class="ss">apache</span><span class="p">.</span><span class="ss">http</span><span class="p">.</span><span class="ss">impl</span><span class="p">.</span><span class="ss">execchain</span><span class="p">.</span><span class="nv">MainClientExec</span><span class="p">.</span><span class="ss">execute</span><span class="p">(</span><span class="nv">MainClientExec</span><span class="p">.</span><span class="ss">java</span><span class="o">:</span><span class="m">236</span><span class="p">)</span>
</code></pre></div></div><ul><li>서비스를 내렸기 때문에, loadbalance에서 갖고있는 instance가 없기 때문에 순수하게 http://crema-gateway란 주소로 호출했지만, 해당 주소로 호스팅 되는 것이 없기 때문에UnknownHostException가 발생했습니다<li>maxRetriesOnSameServiceInstance를 2로 설정했는데 Retry failed last attempt: count=1를 끝으로 retry가 되지 않았습니다.</ul></ul><h3 id="try4"> <a href="#try4" class="anchor-heading" aria-labelledby="try4"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> try4.</h3><ul><li>retry가 한번되고 나서 실행되지 않아서 count 체크하는 로직을 디버깅해봤습니다.<ul><li><code class="language-plaintext highlighter-rouge">LoadBalancedRetryPolicy</code>가 <code class="language-plaintext highlighter-rouge">BlockingLoadBalancedRetryPolicy</code>로 구현되어있기 때문에, <code class="language-plaintext highlighter-rouge">registerThrowable</code> 부분을 디버깅하면 됩니다.<li><p><code class="language-plaintext highlighter-rouge">sameServerCount</code>가 증가되지 않은 이유는 아래 코드에서 false로 리턴되어서인데요.</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">canRetry</span><span class="o">(</span><span class="nc">LoadBalancedRetryContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">HttpMethod</span> <span class="n">method</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getMethod</span><span class="o">();</span>
      <span class="k">return</span> <span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">)</span> <span class="o">||</span> <span class="k">this</span><span class="o">.</span><span class="na">properties</span><span class="o">.</span><span class="na">getRetry</span><span class="o">().</span><span class="na">isRetryOnAllOperations</span><span class="o">();</span>
  <span class="o">}</span>
</code></pre></div></div><li>기본적으로 GET메소드만 retry하고 그 외의 method도 되어야 한다고 하면<code class="language-plaintext highlighter-rouge">retryOnAllOperations</code> 가 true로 설정되어야 합니다.</ul><li><p>그래서 최종적으로 설정한 값입니다</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">spring</span><span class="pi">:</span>
    <span class="na">cloud</span><span class="pi">:</span>
      <span class="na">loadbalancer</span><span class="pi">:</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">clients</span><span class="pi">:</span>
          <span class="na">crema-gateway</span><span class="pi">:</span>
            <span class="na">retry</span><span class="pi">:</span>
              <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
              <span class="na">maxRetriesOnSameServiceInstance</span><span class="pi">:</span> <span class="m">2</span>
              <span class="na">maxRetriesOnNextServiceInstance</span><span class="pi">:</span> <span class="m">2</span>
              <span class="na">retryOnAllOperations</span><span class="pi">:</span> <span class="no">true</span>
              <span class="na">retryableStatusCodes</span><span class="pi">:</span> <span class="s">502, </span><span class="m">503</span>
</code></pre></div></div><ul><li>예를 들어, 이 설정으로 보면 최종적으로 3대의 인스턴스 환경에서 실패할 경우 각각 2번씩 retry하기때문에 총 9번이 실행됩니다.</ul><p><img src="../img/spring_upgrade_retry_4.png" alt="spring_upgrade_retry_4" /></p></ul><h1 id="conclusion"> <a href="#conclusion" class="anchor-heading" aria-labelledby="conclusion"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> conclusion</h1><ul><li>제가 작업하는 어플리케이션에서 FeignClient를 호출할 때 retry가 필요한 경우 2가지 케이스로 동작하게 했습니다.<ul><li>외부 서비스를 loadbalancer에 등록해서 호출하는 경우는 loadbalancer의 retry를 사용<li>그 외의 경우는 Feign의 Retryer를 사용 (이건 <a href="https://tnfhrnsss.github.io/docs/msa/feign/retry/">https://tnfhrnsss.github.io/docs/msa/feign/retry/</a>에서 상세 설명할 예정입니다)</ul></ul><h1 id="reference"> <a href="#reference" class="anchor-heading" aria-labelledby="reference"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> reference</h1><p><a href="https://sabarada.tistory.com/204">[MSA] Hystrix말고 resilience4j ?</a></p><div class="col-lg-8 col-md-10 mx-auto"><hr/> <script src="https://utteranc.es/client.js" repo="tnfhrnsss/tnfhrnsss.github.io" issue-term="url" theme="boxy-light" crossorigin="anonymous" async> </script></div><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2017-2020 Patrick Marsceill. Distributed by an <a href="https://github.com/pmarsceill/just-the-docs/tree/master/LICENSE.txt">MIT license.</a></p><div class="d-flex mt-2"></div></footer></div></div><div class="search-overlay"></div></div>
